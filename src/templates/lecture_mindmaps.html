{% extends "base.html" %} 
{% load static %}
{% block title %}{{ lecture.title }} - Mindmaps{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="{% static 'js/mindmap-utils.js' %}"></script>
{% endblock %} {% block body %}
<div class="mindmaps-container" x-data="mindmapsViewer()" x-init="init()">
  <div class="mindmaps-header">
    <h1>üß† {{ lecture.title }}</h1>
    <p>{{ mindmaps|length }} mindmap{{ mindmaps|pluralize }} generated for this lecture</p>
    <div class="header-actions mindmap-actions">
      <a href="{% url 'main:index' %}" title="Go back">‚Üê Back to Dashboard</a>
    </div>
  </div>

  {% if mindmaps %}
  <div class="mindmap-options">
    {% include "partials/mindmap_theme_selector.html" %}
  </div>

  <div class="mindmaps-grid">
    {% for mindmap in mindmaps %}
    <div class="mindmap-card" data-mindmap-index="{{ forloop.counter0 }}">
      <div class="mindmap-card-header">
        <h2>{{ mindmap.title }}</h2>
        <div class="mindmap-card-actions">
          <button @click="downloadPNG({{ forloop.counter0 }}, '{{ mindmap.title|escapejs }}')" title="Download as PNG">
            üñºÔ∏è PNG
          </button>
        </div>
      </div>
      <div class="mindmap-diagram" :class="{ 'dark-bg': theme === 'dark' }" id="mindmap-body-{{ forloop.counter0 }}">
        <div class="mermaid" id="mermaid-{{ forloop.counter0 }}">
          <div style="padding: 1rem; color: #666;">Loading diagram...</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="no-mindmaps">
    <i class="fa-solid fa-brain"></i>
    <h3>No mindmaps yet</h3>
    <p>Mindmaps will appear here once they are generated for this lecture.</p>
  </div>
  {% endif %}
</div>

<script>
  const mindmapCodes = [
    {% for mindmap in mindmaps %}
    `{{ mindmap.mermaid_code|escapejs }}`,
    {% endfor %}
  ];

  function mindmapsViewer() {
    return {
      theme: 'default',

      async init() {
        MindmapUtils.initMermaid(this.theme);
        await this.renderAllDiagrams();
      },

      async renderAllDiagrams() {
        for (let i = 0; i < mindmapCodes.length; i++) {
          await MindmapUtils.renderDiagram(`mermaid-${i}`, mindmapCodes[i], `mindmap-svg-${i}`);
        }
      },

      async onThemeChange() {
        MindmapUtils.initMermaid(this.theme);
        await this.renderAllDiagrams();
      },

      downloadPNG(index, title) {
        MindmapUtils.downloadPNG(`#mermaid-${index} svg`, `${title}.png`);
      }
    };
  }
</script>
{% endblock %}
