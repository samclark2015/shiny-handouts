{% extends "base.html" %}

{% block title %}{{ title }} - Mindmap{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<style>
    .mindmap-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        min-height: calc(100vh - 200px);
    }
    
    .mindmap-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .mindmap-header h1 {
        font-size: 1.5rem;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .mindmap-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .mindmap-actions button {
        padding: 0.5rem 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        cursor: pointer;
        font-size: 0.875rem;
    }
    
    .mindmap-actions button:hover {
        background: #f5f5f5;
    }
    
    #mindmap-diagram {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 2rem;
        max-width: 100%;
        overflow: auto;
    }
    
    .mermaid {
        display: flex;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="mindmap-container">
    <div class="mindmap-header">
        <h1>{{ title }}</h1>
        <div class="mindmap-actions">
            <button onclick="downloadSVG()" title="Download as SVG">
                üì• Download SVG
            </button>
            <button onclick="downloadPNG()" title="Download as PNG">
                üñºÔ∏è Download PNG
            </button>
            <button onclick="window.history.back()" title="Go back">
                ‚Üê Back
            </button>
        </div>
    </div>
    
    <div id="mindmap-diagram">
        <pre class="mermaid">
{{ mermaid_code }}
        </pre>
    </div>
</div>

<script>
    // Initialize Mermaid
    mermaid.initialize({
        startOnLoad: true,
        theme: 'default',
        mindmap: {
            padding: 20,
            useMaxWidth: true,
        },
        securityLevel: 'loose',
    });

    function downloadSVG() {
        const svg = document.querySelector('#mindmap-diagram svg');
        if (!svg) {
            alert('Diagram not rendered yet. Please wait.');
            return;
        }
        
        const svgData = new XMLSerializer().serializeToString(svg);
        const blob = new Blob([svgData], { type: 'image/svg+xml' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = '{{ title }}.svg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function downloadPNG() {
        const svg = document.querySelector('#mindmap-diagram svg');
        if (!svg) {
            alert('Diagram not rendered yet. Please wait.');
            return;
        }
        
        const svgData = new XMLSerializer().serializeToString(svg);
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
            // Scale up for better quality
            const scale = 2;
            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.scale(scale, scale);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const pngUrl = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = pngUrl;
            a.download = '{{ title }}.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };
        
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
    }
</script>
{% endblock %}
