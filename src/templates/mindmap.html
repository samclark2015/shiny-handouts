{% extends "base.html" %} 
{% load static %}
{% block title %}{{ title }} - Mindmap{% endblock %}
{% block head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="{% static 'js/mindmap-utils.js' %}"></script>
{% endblock %} {% block body %}
<div class="mindmap-container" x-data="mindmapViewer()" x-init="init()">
  <div class="mindmap-header">
    <h1>{{ title }}</h1>
    <div class="mindmap-actions">
      <button @click="window.history.back()" title="Go back">â† Back</button>
      <button @click="downloadPNG()" title="Download as PNG">
        ğŸ–¼ï¸ Download PNG
      </button>
    </div>
  </div>

  <div class="mindmap-options centered">
    {% include "partials/mindmap_theme_selector.html" %}

    <div class="option-group">
      <label>ğŸ” Zoom:</label>
      <input type="range" min="50" max="200" x-model="zoom" step="10" @input="updateZoom()">
      <span class="range-value" x-text="zoom + '%'"></span>
    </div>

    <div class="option-group">
      <label>ğŸ“ Padding:</label>
      <input type="range" min="10" max="100" x-model="padding" step="10" @input="onThemeChange()">
      <span class="range-value" x-text="padding + 'px'"></span>
    </div>
  </div>

  <div id="mindmap-diagram" class="mindmap-diagram large" :class="{ 'dark-bg': theme === 'dark' }">
    <pre class="mermaid" id="mermaid-content">
{{ mermaid_code }}
        </pre
    >
  </div>
</div>

<script>
  const originalMermaidCode = `{{ mermaid_code|escapejs }}`;
  const mindmapTitle = `{{ title|escapejs }}`;

  function mindmapViewer() {
    return {
      theme: 'default',
      zoom: 100,
      padding: 40,

      init() {
        MindmapUtils.initMermaid(this.theme, this.padding);
        MindmapUtils.renderDiagram('mermaid-content', originalMermaidCode, 'mindmap-svg')
          .then(() => this.updateZoom());
      },

      async onThemeChange() {
        MindmapUtils.initMermaid(this.theme, this.padding);
        await MindmapUtils.renderDiagram('mermaid-content', originalMermaidCode, 'mindmap-svg');
        this.updateZoom();
      },

      updateZoom() {
        MindmapUtils.applyZoom('.mermaid', this.zoom);
      },

      downloadPNG() {
        MindmapUtils.downloadPNG('#mindmap-diagram svg', mindmapTitle + '.png');
      }
    };
  }
</script>
{% endblock %}
